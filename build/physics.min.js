/**
 * Physics
 * A requirified port of Traer Physics from Processing to JavaScript.
 * Copyright (C) 2012 jonobr1
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
(function(){common=function(){var f={},h=Array.prototype,a=Object.prototype,g=a.hasOwnProperty,e=h.slice,c=h.forEach,k=h.indexOf,b=a.toString,d=function(b,d,g){if(null!=b)if(c&&b.forEach===c)b.forEach(d,g);else if(b.length===+b.length)for(var a=0,e=b.length;a<e&&!(a in b&&d.call(g,b[a],a,b)===f);a++);else for(a in b)if(_.has(b,a)&&d.call(g,b[a],a,b)===f)break},q=function(b){return b},m=function(b,c,d){d||(d=q);for(var g=0,a=b.length;g<a;){var e=g+a>>1;d(b[e])<d(c)?g=e+1:a=e}return g};return{has:function(b,
d){return g.call(b,d)},each:d,extend:function(b){d(e.call(arguments,1),function(d){for(var c in d)b[c]=d[c]});return b},indexOf:function(b,d,c){if(null==b)return-1;var g;if(c)return c=m(b,d),b[c]===d?c:-1;if(k&&b.indexOf===k)return b.indexOf(d);c=0;for(g=b.length;c<g;c++)if(c in b&&b[c]===d)return c;return-1},sortedIndex:m,identity:q,isNumber:function(c){return"[object Number]"==b.call(c)},isFunction:function(c){return"[object Function]"==b.call(c)||"function"==typeof c},isUndefined:function(b){return void 0===
b},isNull:function(b){return null===b}}}();Vector=function(f){var h=function(a,g){this.x=a||0;this.y=g||0};f.extend(h.prototype,{set:function(a,g){this.x=a;this.y=g;return this},copy:function(a){this.x=a.x;this.y=a.y;return this},clear:function(){this.y=this.x=0;return this},clone:function(){return new h(this.x,this.y)},add:function(a,g){this.x=a.x+g.x;this.y=a.y+g.y;return this},addSelf:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a,g){this.x=a.x-g.x;this.y=a.y-g.y;return this},
subSelf:function(a){this.x-=a.x;this.y-=a.y;return this},multiplySelf:function(a){this.x*=a.x;this.y*=a.y;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;return this},divideScalar:function(a){a?(this.x/=a,this.y/=a):this.set(0,0);return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y},lengthSquared:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){return this.divideScalar(this.length())},
distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var g=this.x-a.x;a=this.y-a.y;return g*g+a*a},setLength:function(a){return this.normalize().multiplyScalar(a)},equals:function(a){return 1E-4>this.distanceTo(a)},lerp:function(a,g){return this.set((a.x-this.x)*g+this.x,(a.y-this.y)*g+this.y)},isZero:function(){return 1E-4>this.length()}});return h}(common);this.Physics=Physics=function(f,h,a){function g(){var c=this,a;this.tick();for(a=0;a<this.animations.length;a++)this.animations[a]();
(this.__optimized&&!this.__equilibrium||!this.__optimized)&&this.playing&&h(function(){g.call(c)});if(this.__optimized&&this.__equilibrium)for(a=0;a<this.equilibriumCallbacks.length;a++)this.equilibriumCallbacks[a]()}var e=function(){this.playing=!1;f.apply(this,arguments);this.animations=[];this.equilibriumCallbacks=[];g.call(this)};a.extend(e,f,{superclass:f});a.extend(e.prototype,f.prototype,{play:function(){if(this.playing)return this;this.playing=!0;this.__equilibrium=!1;g.call(this);return this},
pause:function(){this.playing=!1;return this},toggle:function(){this.playing?this.pause():this.play();return this},onUpdate:function(c){if(0<=a.indexOf(this.animations,c)||!a.isFunction(c))return this;this.animations.push(c);return this},onEquilibrium:function(c){if(0<=a.indexOf(this.equilibriumCallbacks,c)||!a.isFunction(c))return this;this.equilibriumCallbacks.push(c);return this},update:function(){if(!this.__equilibrium)return this;this.__equilibrium=!1;this.playing&&g.call(this);return this}});
return e}(ParticleSystem=function(f,h,a,g,e,c){var k=function(){this.__equilibriumCriteria={particles:!0,springs:!0,attractions:!0};this.__optimized=this.__equilibrium=!1;this.particles=[];this.springs=[];this.attractions=[];this.forces=[];this.integrator=new e(this);this.hasDeadParticles=!1;var b=arguments.length;1===b?(this.gravity=new f(0,arguments[0]),this.drag=k.DEFAULT_DRAG):2===b?(this.gravity=new f(0,arguments[0]),this.drag=arguments[1]):3===b?(this.gravity=new f(arguments[0],arguments[1]),
this.drag=arguments[3]):(this.gravity=new f(0,k.DEFAULT_GRAVITY),this.drag=k.DEFAULT_DRAG)};c.extend(k,{DEFAULT_GRAVITY:0,DEFAULT_DRAG:.001,Attraction:g,Integrator:e,Particle:h,Spring:a,Vector:f});c.extend(k.prototype,{optimize:function(b){this.__optimized=!!b;return this},setGravity:function(b,c){this.gravity.set(b,c);return this},setEquilibriumCriteria:function(b,c,a){this.__equilibriumCriteria.particles=!!b;this.__equilibriumCriteria.springs=!!c;this.__equilibriumCriteria.attractions=!!a},tick:function(){this.integrator.step(0===
arguments.length?1:arguments[0]);this.__optimized&&(this.__equilibrium=!this.needsUpdate());return this},needsUpdate:function(){var b=0;if(this.__equilibriumCriteria.particles)for(b=0,l=this.particles.length;b<l;b++)if(!this.particles[b].resting())return!0;if(this.__equilibriumCriteria.springs)for(b=0,l=this.springs.length;b<l;b++)if(!this.springs[b].resting())return!0;if(this.__equilibriumCriteria.attractions)for(b=0,l=this.attractions.length;b<l;b++)if(!this.attractions[b].resting())return!0;return!1},
addParticle:function(b){this.particles.push(b);return this},addSpring:function(b){this.springs.push(b);return this},addAttraction:function(b){this.attractions.push(b);return this},makeParticle:function(b,d,a){b=c.isNumber(b)?b:1;d=d||0;a=a||0;b=new h(b);b.position.set(d,a);this.addParticle(b);return b},makeSpring:function(b,c,g,e,f){b=new a(b,c,g,e,f);this.addSpring(b);return b},makeAttraction:function(b,c,a,e){b=new g(b,c,a,e);this.addAttraction(b);return b},clear:function(){this.particles.length=
0;this.springs.length=0;this.attractions.length=0},applyForces:function(){var b,c;if(!this.gravity.isZero())for(b=0;b<this.particles.length;b++)this.particles[b].force.addSelf(this.gravity);var a=new f;for(b=0;b<this.particles.length;b++)c=this.particles[b],a.set(-1*c.velocity.x*this.drag,-1*c.velocity.y*this.drag),c.force.addSelf(a);for(b=0;b<this.springs.length;b++)this.springs[b].update();for(b=0;b<this.attractions.length;b++)this.attractions[b].update();for(b=0;b<this.forces.length;b++)this.forces[b].update();
return this},clearForces:function(){for(var b=0;b<this.particles.length;b++)this.particles[b].clear();return this}});return k}(Vector,Particle=function(f,h){var a=function(a){this.position=new f;this.velocity=new f;this.force=new f;this.mass=a;this.fixed=!1;this.age=0;this.dead=!1};h.extend(a.prototype,{distanceTo:function(a){return this.position.distanceTo(a.position)},makeFixed:function(){this.fixed=!0;this.velocity.clear();return this},reset:function(){this.age=0;this.dead=!1;this.position.clear();
this.velocity.clear();this.force.clear();this.mass=1;return this},resting:function(){return this.fixed||this.velocity.isZero()&&this.force.isZero()}});return a}(Vector,common),Spring=function(f,h){var a=function(a,e,c,f,b){this.constant=c;this.damping=f;this.length=b;this.a=a;this.b=e;this.on=!0};h.extend(a.prototype,{currentLength:function(){return this.a.position.distanceTo(this.b.position)},update:function(){var a=this.a,e=this.b;if(!this.on||a.fixed&&e.fixed)return this;var c=(new f).sub(a.position,
e.position),k=c.length();0===k?c.clear():c.divideScalar(k);var k=-1*(k-this.length)*this.constant,b=(new f).sub(a.velocity,e.velocity),b=-1*this.damping*b.dot(c);c.multiplyScalar(k+b);a.fixed||a.force.addSelf(c);e.fixed||e.force.subSelf(c);return this},resting:function(){var a=this.a,e=this.b,c=this.length;return!this.on||a.fixed&&e.fixed||a.fixed&&(0===c?e.position.equals(a.position):e.position.distanceTo(a.position)<=c)&&e.resting()||e.fixed&&(0===c?a.position.equals(e.position):a.position.distanceTo(e.position)<=
c)&&a.resting()}});return a}(Vector,common),Attraction=function(f,h){var a=function(a,e,c,f){this.a=a;this.b=e;this.constant=c;this.on=!0;this.distanceMin=f;this.distanceMinSquared=f*f};h.extend(a.prototype,{update:function(){var a=this.a,e=this.b;if(!(!this.on||a.fixed&&e.fixed)){var c=(new f).sub(a.position,e.position),k=Math.max(c.lengthSquared(),this.distanceMinSquared),b=this.constant*a.mass*e.mass/k,k=Math.sqrt(k);0===b||0===k?c.clear():c.divideScalar(k).multiplyScalar(b);a.fixed||a.force.subSelf(c);
e.fixed||e.force.addSelf(c);return this}},resting:function(){var a=this.a,e=this.b,c=this.distanceMin;return!this.on||a.fixed&&e.fixed||a.fixed&&e.position.distanceTo(a.position)<=c&&e.resting()||e.fixed&&a.position.distanceTo(e.position)<=c&&a.resting()}});return a}(Vector,common),Integrator=function(f,h){var a=function(a){this.s=a;this.originalPositions=[];this.originalVelocities=[];this.k1Forces=[];this.k1Velocities=[];this.k2Forces=[];this.k2Velocities=[];this.k3Forces=[];this.k3Velocities=[];
this.k4Forces=[];this.k4Velocities=[]};h.extend(a.prototype,{allocateParticles:function(){for(;this.s.particles.length>this.originalPositions.length;)this.originalPositions.push(new f),this.originalVelocities.push(new f),this.k1Forces.push(new f),this.k1Velocities.push(new f),this.k2Forces.push(new f),this.k2Velocities.push(new f),this.k3Forces.push(new f),this.k3Velocities.push(new f),this.k4Forces.push(new f),this.k4Velocities.push(new f);return this},step:function(a){var e=this.s,c,f,b,d,h,m,n,
p;this.allocateParticles();for(d=0;d<e.particles.length;d++)c=e.particles[d],c.fixed||(this.originalPositions[d].copy(c.position),this.originalVelocities[d].copy(c.velocity)),c.force.clear();e.applyForces();for(d=0;d<e.particles.length;d++)c=e.particles[d],c.fixed||(this.k1Forces[d].copy(c.force),this.k1Velocities[d].copy(c.velocity)),c.force.clear();for(d=0;d<e.particles.length;d++)c=e.particles[d],c.fixed||(b=this.originalPositions[d],h=this.k1Velocities[d],f=b.x+.5*h.x*a,b=b.y+.5*h.y*a,c.position.set(f,
b),b=this.originalVelocities[d],h=this.k1Forces[d],f=b.x+.5*h.x*a/c.mass,b=b.y+.5*h.y*a/c.mass,c.velocity.set(f,b));e.applyForces();for(d=0;d<e.particles.length;d++)c=e.particles[d],c.fixed||(this.k2Forces[d].copy(c.force),this.k2Velocities[d].copy(c.velocity)),c.force.clear();for(d=0;d<e.particles.length;d++)c=e.particles[d],c.fixed||(b=this.originalPositions[d],m=this.k2Velocities[d],c.position.set(b.x+.5*m.x*a,b.y+.5*m.y*a),b=this.originalVelocities[d],m=this.k2Forces[d],c.velocity.set(b.x+.5*
m.x*a/c.mass,b.y+.5*m.y*a/c.mass));e.applyForces();for(d=0;d<e.particles.length;d++)c=e.particles[d],c.fixed||(this.k3Forces[d].copy(c.force),this.k3Velocities[d].copy(c.velocity)),c.force.clear();for(d=0;d<e.particles.length;d++)c=e.particles[d],c.fixed||(b=this.originalPositions[d],n=this.k3Velocities[d],c.position.set(b.x+n.x*a,b.y+n.y*a),b=this.originalVelocities[d],n=this.k3Forces[d],c.velocity.set(b.x+n.x*a/c.mass,b.y+n.y*a/c.mass));e.applyForces();for(d=0;d<e.particles.length;d++)c=e.particles[d],
c.fixed||(this.k4Forces[d].copy(c.force),this.k4Velocities[d].copy(c.velocity));for(d=0;d<e.particles.length;d++)c=e.particles[d],c.age+=a,c.fixed||(b=this.originalPositions[d],h=this.k1Velocities[d],m=this.k2Velocities[d],n=this.k3Velocities[d],p=this.k4Velocities[d],f=b.x+a/6*(h.x+2*m.x+2*n.x+p.x),b=b.y+a/6*(h.y+2*m.y+2*n.y+p.y),c.position.set(f,b),b=this.originalVelocities[d],h=this.k1Forces[d],m=this.k2Forces[d],n=this.k3Forces[d],p=this.k4Forces[d],f=b.x+a/(6*c.mass)*(h.x+2*m.x+2*n.x+p.x),b=
b.y+a/(6*c.mass)*(h.y+2*m.y+2*n.y+p.y),c.velocity.set(f,b));return this}});return a}(Vector,common),common),requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(f){window.setTimeout(f,1E3/60)}}(),common)})();